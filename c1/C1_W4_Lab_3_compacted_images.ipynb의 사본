{"cells":[{"cell_type":"markdown","metadata":{"id":"0XmK6Q8TTp8a"},"source":["<a href=\"https://colab.research.google.com/github/https-deeplearning-ai/tensorflow-1-public/blob/master/C1/W4/ungraded_labs/C1_W4_Lab_3_compacted_images.ipynb\" target=\"_parent\"><img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a>"]},{"cell_type":"markdown","metadata":{"id":"qR8Am0lBtRAx"},"source":["# Ungraded Lab: Effect of Compacted Images in Training\n","\n","In this notebook, you will see how reducing the target size of the generator images will affect the architecture and performance of your model. This is a useful technique in case you need to speed up your training or save compute resources. Let's begin!"]},{"cell_type":"markdown","metadata":{"id":"D1iD7DhP2NWt"},"source":["**IMPORTANT NOTE:** This notebook is designed to run as a Colab. Running it on your local machine might result in some of the code blocks throwing errors."]},{"cell_type":"code","execution_count":1,"metadata":{"id":"npYpcdLzTp8c","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191148848,"user_tz":-540,"elapsed":59419,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"4ea94d5e-22f3-4a35-c28c-59342a1d8c35"},"outputs":[{"output_type":"stream","name":"stdout","text":["Reading package lists... Done\n","Building dependency tree       \n","Reading state information... Done\n","The following package was automatically installed and is no longer required:\n","  libnvidia-common-460\n","Use 'apt autoremove' to remove it.\n","The following packages will be REMOVED:\n","  libcudnn8-dev\n","The following held packages will be changed:\n","  libcudnn8\n","The following packages will be upgraded:\n","  libcudnn8\n","1 upgraded, 0 newly installed, 1 to remove and 18 not upgraded.\n","Need to get 420 MB of archives.\n","After this operation, 3,369 MB disk space will be freed.\n","Get:1 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  libcudnn8 8.4.1.50-1+cuda11.6 [420 MB]\n","Fetched 420 MB in 14s (30.0 MB/s)\n","(Reading database ... 155685 files and directories currently installed.)\n","Removing libcudnn8-dev (8.0.5.39-1+cuda11.1) ...\n","(Reading database ... 155663 files and directories currently installed.)\n","Preparing to unpack .../libcudnn8_8.4.1.50-1+cuda11.6_amd64.deb ...\n","Unpacking libcudnn8 (8.4.1.50-1+cuda11.6) over (8.0.5.39-1+cuda11.1) ...\n","Setting up libcudnn8 (8.4.1.50-1+cuda11.6) ...\n"]}],"source":["# Install this package to use Colab's GPU for training\n","!apt install --allow-change-held-packages libcudnn8=8.4.1.50-1+cuda11.6"]},{"cell_type":"markdown","metadata":{"id":"qxY7KvGQ2Qdr"},"source":["As before, start downloading the train and validation sets:"]},{"cell_type":"code","execution_count":2,"metadata":{"id":"RXZT2UsyIVe_","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191151203,"user_tz":-540,"elapsed":2365,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"0087af11-1275-4f18-becc-7425f55c3d8a"},"outputs":[{"output_type":"stream","name":"stdout","text":["--2022-09-03 07:45:48--  https://storage.googleapis.com/tensorflow-1-public/course2/week3/horse-or-human.zip\n","Resolving storage.googleapis.com (storage.googleapis.com)... 74.125.24.128, 172.217.194.128, 142.251.10.128, ...\n","Connecting to storage.googleapis.com (storage.googleapis.com)|74.125.24.128|:443... connected.\n","HTTP request sent, awaiting response... 200 OK\n","Length: 149574867 (143M) [application/zip]\n","Saving to: ‘horse-or-human.zip’\n","\n","horse-or-human.zip  100%[===================>] 142.65M   151MB/s    in 0.9s    \n","\n","2022-09-03 07:45:49 (151 MB/s) - ‘horse-or-human.zip’ saved [149574867/149574867]\n","\n"]}],"source":["# Download the training set\n","!wget https://storage.googleapis.com/tensorflow-1-public/course2/week3/horse-or-human.zip"]},{"cell_type":"code","execution_count":3,"metadata":{"id":"0mLij6qde6Ox","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191151832,"user_tz":-540,"elapsed":634,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"05f71c36-84e8-40f5-d3a8-a7340b565953"},"outputs":[{"output_type":"stream","name":"stdout","text":["--2022-09-03 07:45:49--  https://storage.googleapis.com/tensorflow-1-public/course2/week3/validation-horse-or-human.zip\n","Resolving storage.googleapis.com (storage.googleapis.com)... 74.125.24.128, 172.217.194.128, 142.251.10.128, ...\n","Connecting to storage.googleapis.com (storage.googleapis.com)|74.125.24.128|:443... connected.\n","HTTP request sent, awaiting response... 200 OK\n","Length: 11480187 (11M) [application/zip]\n","Saving to: ‘validation-horse-or-human.zip’\n","\n","validation-horse-or 100%[===================>]  10.95M  25.6MB/s    in 0.4s    \n","\n","2022-09-03 07:45:50 (25.6 MB/s) - ‘validation-horse-or-human.zip’ saved [11480187/11480187]\n","\n"]}],"source":["# Download the validation set\n","!wget https://storage.googleapis.com/tensorflow-1-public/course2/week3/validation-horse-or-human.zip"]},{"cell_type":"markdown","metadata":{"id":"9brUxyTpYZHy"},"source":["Then unzip them:"]},{"cell_type":"code","execution_count":4,"metadata":{"id":"PLy3pthUS0D2","executionInfo":{"status":"ok","timestamp":1662191151833,"user_tz":-540,"elapsed":10,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}}},"outputs":[],"source":["import zipfile\n","\n","# Unzip training set\n","local_zip = './horse-or-human.zip'\n","zip_ref = zipfile.ZipFile(local_zip, 'r')\n","zip_ref.extractall('./horse-or-human')\n","\n","# Unzip validation set\n","local_zip = './validation-horse-or-human.zip'\n","zip_ref = zipfile.ZipFile(local_zip, 'r')\n","zip_ref.extractall('./validation-horse-or-human')\n","\n","zip_ref.close()"]},{"cell_type":"markdown","metadata":{"id":"o-qUPyfO7Qr8"},"source":["Then define the directories containing the images:"]},{"cell_type":"code","execution_count":5,"metadata":{"id":"NR_M9nWN-K8B","executionInfo":{"status":"ok","timestamp":1662191151833,"user_tz":-540,"elapsed":10,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}}},"outputs":[],"source":["import os\n","\n","# Directory with training horse pictures\n","train_horse_dir = os.path.join('./horse-or-human/horses')\n","\n","# Directory with training human pictures\n","train_human_dir = os.path.join('./horse-or-human/humans')\n","\n","# Directory with validation horse pictures\n","validation_horse_dir = os.path.join('./validation-horse-or-human/horses')\n","\n","# Directory with validation human pictures\n","validation_human_dir = os.path.join('./validation-horse-or-human/humans')"]},{"cell_type":"markdown","metadata":{"id":"z1wrZCxTPw4m"},"source":["You can check that the directories are not empty and that the train set has more images than the validation set:"]},{"cell_type":"code","execution_count":6,"metadata":{"id":"AEbMHusATp8g","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191151834,"user_tz":-540,"elapsed":9,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"00a6f960-a55e-4823-9af8-2b7765857356"},"outputs":[{"output_type":"stream","name":"stdout","text":["TRAIN SET HORSES: ['horse20-9.png', 'horse44-2.png', 'horse17-6.png', 'horse07-3.png', 'horse49-3.png', 'horse28-3.png', 'horse41-0.png', 'horse02-2.png', 'horse17-7.png', 'horse08-1.png']\n","TRAIN SET HUMANS: ['human01-15.png', 'human11-27.png', 'human04-01.png', 'human03-07.png', 'human09-26.png', 'human04-22.png', 'human05-28.png', 'human12-16.png', 'human05-19.png', 'human10-30.png']\n","VAL SET HORSES: ['horse3-217.png', 'horse2-544.png', 'horse5-458.png', 'horse4-541.png', 'horse2-218.png', 'horse1-436.png', 'horse2-011.png', 'horse5-235.png', 'horse3-198.png', 'horse4-232.png']\n","VAL SET HUMANS: ['valhuman01-15.png', 'valhuman03-13.png', 'valhuman03-04.png', 'valhuman05-07.png', 'valhuman02-07.png', 'valhuman05-06.png', 'valhuman04-07.png', 'valhuman05-00.png', 'valhuman03-02.png', 'valhuman01-24.png']\n"]}],"source":["train_horse_names = os.listdir(train_horse_dir)\n","print(f'TRAIN SET HORSES: {train_horse_names[:10]}')\n","\n","train_human_names = os.listdir(train_human_dir)\n","print(f'TRAIN SET HUMANS: {train_human_names[:10]}')\n","\n","validation_horse_hames = os.listdir(validation_horse_dir)\n","print(f'VAL SET HORSES: {validation_horse_hames[:10]}')\n","\n","validation_human_names = os.listdir(validation_human_dir)\n","print(f'VAL SET HUMANS: {validation_human_names[:10]}')"]},{"cell_type":"code","execution_count":7,"metadata":{"id":"ZTpdVrBg2LZC","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191151834,"user_tz":-540,"elapsed":7,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"43771f18-913b-48e6-880b-eea340303bbc"},"outputs":[{"output_type":"stream","name":"stdout","text":["total training horse images: 500\n","total training human images: 527\n","total validation horse images: 128\n","total validation human images: 128\n"]}],"source":["print(f'total training horse images: {len(os.listdir(train_horse_dir))}')\n","print(f'total training human images: {len(os.listdir(train_human_dir))}')\n","print(f'total validation horse images: {len(os.listdir(validation_horse_dir))}')\n","print(f'total validation human images: {len(os.listdir(validation_human_dir))}')"]},{"cell_type":"markdown","metadata":{"id":"5oqBkNBJmtUv"},"source":["## Build the Model\n","\n","The model will follow the same architecture as before but they key difference is in the `input_shape` parameter of the first `Conv2D` layer. Since you will be compacting the images later in the generator, you need to specify the expected image size here. So instead of 300x300 as in the previous two labs, you specify a smaller 150x150 array."]},{"cell_type":"code","execution_count":8,"metadata":{"id":"PixZ2s5QbYQ3","executionInfo":{"status":"ok","timestamp":1662191157480,"user_tz":-540,"elapsed":5651,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}}},"outputs":[],"source":["import tensorflow as tf\n","\n","model = tf.keras.models.Sequential([\n","    # Note the input shape is the desired size of the image 150x150 with 3 bytes color\n","    # This is the first convolution\n","    tf.keras.layers.Conv2D(16, (3,3), activation='relu', input_shape=(150, 150, 3)),\n","    tf.keras.layers.MaxPooling2D(2, 2),\n","    # The second convolution\n","    tf.keras.layers.Conv2D(32, (3,3), activation='relu'),\n","    tf.keras.layers.MaxPooling2D(2,2),\n","    # The third convolution\n","    tf.keras.layers.Conv2D(64, (3,3), activation='relu'),\n","    tf.keras.layers.MaxPooling2D(2,2),\n","#     # The fourth convolution (You can uncomment the 4th and 5th conv layers later to see the effect)\n","#     tf.keras.layers.Conv2D(64, (3,3), activation='relu'),\n","#     tf.keras.layers.MaxPooling2D(2,2),\n","#     # The fifth convolution\n","#     tf.keras.layers.Conv2D(64, (3,3), activation='relu'),\n","#     tf.keras.layers.MaxPooling2D(2,2),\n","    # Flatten the results to feed into a DNN\n","    tf.keras.layers.Flatten(),\n","    # 512 neuron hidden layer\n","    tf.keras.layers.Dense(512, activation='relu'),\n","    # Only 1 output neuron. It will contain a value from 0-1 where 0 for 1 class ('horses') and 1 for the other ('humans')\n","    tf.keras.layers.Dense(1, activation='sigmoid')\n","])"]},{"cell_type":"markdown","metadata":{"id":"s9EaFDP5srBa"},"source":["You can see the difference from previous models when you print the `model.summary()`. As expected, there will be less inputs to the `Dense` layer at the end of the model compared to the previous labs. This is because you used the same number of max pooling layers in your model. And since you have a smaller image to begin with (150 x 150), then the output after all the pooling layers will also be smaller."]},{"cell_type":"code","execution_count":9,"metadata":{"id":"7ZKj8392nbgP","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191158065,"user_tz":-540,"elapsed":610,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"f8363bc4-1e75-41be-87c3-07e1852910dc"},"outputs":[{"output_type":"stream","name":"stdout","text":["Model: \"sequential\"\n","_________________________________________________________________\n"," Layer (type)                Output Shape              Param #   \n","=================================================================\n"," conv2d (Conv2D)             (None, 148, 148, 16)      448       \n","                                                                 \n"," max_pooling2d (MaxPooling2D  (None, 74, 74, 16)       0         \n"," )                                                               \n","                                                                 \n"," conv2d_1 (Conv2D)           (None, 72, 72, 32)        4640      \n","                                                                 \n"," max_pooling2d_1 (MaxPooling  (None, 36, 36, 32)       0         \n"," 2D)                                                             \n","                                                                 \n"," conv2d_2 (Conv2D)           (None, 34, 34, 64)        18496     \n","                                                                 \n"," max_pooling2d_2 (MaxPooling  (None, 17, 17, 64)       0         \n"," 2D)                                                             \n","                                                                 \n"," flatten (Flatten)           (None, 18496)             0         \n","                                                                 \n"," dense (Dense)               (None, 512)               9470464   \n","                                                                 \n"," dense_1 (Dense)             (None, 1)                 513       \n","                                                                 \n","=================================================================\n","Total params: 9,494,561\n","Trainable params: 9,494,561\n","Non-trainable params: 0\n","_________________________________________________________________\n"]}],"source":["model.summary()"]},{"cell_type":"markdown","metadata":{"id":"PEkKSpZlvJXA"},"source":["You will use the same settings for training:"]},{"cell_type":"code","execution_count":10,"metadata":{"id":"8DHWhFP_uhq3","executionInfo":{"status":"ok","timestamp":1662191210127,"user_tz":-540,"elapsed":482,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}}},"outputs":[],"source":["from tensorflow.keras.optimizers import RMSprop\n","\n","model.compile(loss='binary_crossentropy',\n","              optimizer=RMSprop(learning_rate=0.001),\n","              metrics=['accuracy'])"]},{"cell_type":"markdown","metadata":{"id":"Sn9m9D3UimHM"},"source":["### Data Preprocessing\n","\n","Now you will instantiate the data generators. As mentioned before, you will be compacting the image by specifying the `target_size` parameter. See the simple change below:"]},{"cell_type":"code","execution_count":11,"metadata":{"id":"ClebU9NJg99G","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191216841,"user_tz":-540,"elapsed":6,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"4552c469-1206-4c63-f6ca-52da848d0ba7"},"outputs":[{"output_type":"stream","name":"stdout","text":["Found 1027 images belonging to 2 classes.\n","Found 256 images belonging to 2 classes.\n"]}],"source":["from tensorflow.keras.preprocessing.image import ImageDataGenerator\n","\n","# All images will be rescaled by 1./255\n","train_datagen = ImageDataGenerator(rescale=1/255)\n","validation_datagen = ImageDataGenerator(rescale=1/255)\n","\n","# Flow training images in batches of 128 using train_datagen generator\n","train_generator = train_datagen.flow_from_directory(\n","        './horse-or-human/',  # This is the source directory for training images\n","        target_size=(150, 150),  # All images will be resized to 150x150\n","        batch_size=128,\n","        # Since you used binary_crossentropy loss, you need binary labels\n","        class_mode='binary')\n","\n","# Flow training images in batches of 128 using train_datagen generator\n","validation_generator = validation_datagen.flow_from_directory(\n","        './validation-horse-or-human/',  # This is the source directory for training images\n","        target_size=(150, 150),  # All images will be resized to 150x150\n","        batch_size=32,\n","        # Since you used binary_crossentropy loss, you need binary labels\n","        class_mode='binary')"]},{"cell_type":"markdown","metadata":{"id":"mu3Jdwkjwax4"},"source":["### Training\n","\n","Now you're ready to train and see the results. Note your observations about how fast the model trains and the accuracies you're getting in the train and validation sets."]},{"cell_type":"code","execution_count":12,"metadata":{"id":"Fb1_lgobv81m","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1662191378270,"user_tz":-540,"elapsed":141356,"user":{"displayName":"‍조성우[ 학부재학 / 산업경영공학부 ]","userId":"07929875586727967845"}},"outputId":"a41feda4-67ae-46c6-e233-a4657c0cd84e"},"outputs":[{"output_type":"stream","name":"stdout","text":["Epoch 1/15\n","8/8 [==============================] - 11s 698ms/step - loss: 1.7695 - accuracy: 0.5017 - val_loss: 0.6252 - val_accuracy: 0.5781\n","Epoch 2/15\n","8/8 [==============================] - 6s 885ms/step - loss: 0.6261 - accuracy: 0.7175 - val_loss: 0.4790 - val_accuracy: 0.7930\n","Epoch 3/15\n","8/8 [==============================] - 6s 747ms/step - loss: 0.5180 - accuracy: 0.8676 - val_loss: 0.9621 - val_accuracy: 0.7969\n","Epoch 4/15\n","8/8 [==============================] - 6s 794ms/step - loss: 0.1648 - accuracy: 0.9268 - val_loss: 0.6094 - val_accuracy: 0.8438\n","Epoch 5/15\n","8/8 [==============================] - 6s 798ms/step - loss: 0.0763 - accuracy: 0.9785 - val_loss: 0.7395 - val_accuracy: 0.8828\n","Epoch 6/15\n","8/8 [==============================] - 6s 740ms/step - loss: 0.2484 - accuracy: 0.9021 - val_loss: 1.2337 - val_accuracy: 0.8281\n","Epoch 7/15\n","8/8 [==============================] - 6s 741ms/step - loss: 0.0484 - accuracy: 0.9833 - val_loss: 1.3976 - val_accuracy: 0.8086\n","Epoch 8/15\n","8/8 [==============================] - 6s 734ms/step - loss: 0.0178 - accuracy: 0.9944 - val_loss: 1.8710 - val_accuracy: 0.7969\n","Epoch 9/15\n","8/8 [==============================] - 6s 741ms/step - loss: 0.2309 - accuracy: 0.9177 - val_loss: 0.8972 - val_accuracy: 0.8125\n","Epoch 10/15\n","8/8 [==============================] - 6s 787ms/step - loss: 0.0328 - accuracy: 0.9971 - val_loss: 1.2677 - val_accuracy: 0.8555\n","Epoch 11/15\n","8/8 [==============================] - 6s 741ms/step - loss: 0.2934 - accuracy: 0.9255 - val_loss: 1.1231 - val_accuracy: 0.8008\n","Epoch 12/15\n","8/8 [==============================] - 6s 743ms/step - loss: 0.0390 - accuracy: 0.9911 - val_loss: 1.7441 - val_accuracy: 0.7930\n","Epoch 13/15\n","8/8 [==============================] - 7s 851ms/step - loss: 0.0141 - accuracy: 0.9967 - val_loss: 1.4378 - val_accuracy: 0.8516\n","Epoch 14/15\n","8/8 [==============================] - 6s 750ms/step - loss: 0.0043 - accuracy: 1.0000 - val_loss: 1.7166 - val_accuracy: 0.8516\n","Epoch 15/15\n","8/8 [==============================] - 6s 740ms/step - loss: 0.0024 - accuracy: 1.0000 - val_loss: 1.9643 - val_accuracy: 0.8398\n"]}],"source":["history = model.fit(\n","      train_generator,\n","      steps_per_epoch=8,  \n","      epochs=15,\n","      verbose=1,\n","      validation_data = validation_generator,\n","      validation_steps=8)"]},{"cell_type":"markdown","metadata":{"id":"o6vSHzPR2ghH"},"source":["### Model Prediction\n","\n","As usual, it is also good practice to try running your model over some handpicked images. See if you got better, worse, or the same performance as the previous lab.\n","\n","**Important Note:** Due to some compatibility issues, the following code block will result in an error after you select the images(s) to upload if you are running this notebook as a `Colab` on the `Safari` browser. For all other browsers, continue with the next code block and ignore the next one after it.\n","\n","_For Safari users: please comment out or skip the code block below, uncomment the next code block and run it._"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"DoWp43WxJDNT"},"outputs":[],"source":["## CODE BLOCK FOR NON-SAFARI BROWSERS\n","## SAFARI USERS: PLEASE SKIP THIS BLOCK AND RUN THE NEXT ONE INSTEAD\n","\n","import numpy as np\n","from google.colab import files\n","from keras.preprocessing import image\n","\n","uploaded = files.upload()\n","\n","for fn in uploaded.keys():\n"," \n","  # predicting images\n","  path = '/content/' + fn\n","  img = image.load_img(path, target_size=(150, 150))\n","  x = image.img_to_array(img)\n","  x /= 255\n","  x = np.expand_dims(x, axis=0)\n","\n","  images = np.vstack([x])\n","  classes = model.predict(images, batch_size=10)\n","  print(classes[0])\n","  if classes[0]>0.5:\n","    print(fn + \" is a human\")\n","  else:\n","    print(fn + \" is a horse\")\n"," "]},{"cell_type":"markdown","metadata":{"id":"ckps9Sw4657d"},"source":["`Safari` users will need to upload the images(s) manually in their workspace. Please follow the instructions, uncomment the code block below and run it.\n","\n","Instructions on how to upload image(s) manually in a Colab:\n","\n","1. Select the `folder` icon on the left `menu bar`.\n","2. Click on the `folder with an arrow pointing upwards` named `..`\n","3. Click on the `folder` named `tmp`.\n","4. Inside of the `tmp` folder, `create a new folder` called `images`. You'll see the `New folder` option by clicking the `3 vertical dots` menu button next to the `tmp` folder.\n","5. Inside of the new `images` folder, upload an image(s) of your choice, preferably of either a horse or a human. Drag and drop the images(s) on top of the `images` folder.\n","6. Uncomment and run the code block below. "]},{"cell_type":"code","execution_count":null,"metadata":{"id":"v_GgQjRT65oM"},"outputs":[],"source":["# # CODE BLOCK FOR SAFARI USERS\n","\n","# import numpy as np\n","# from keras.preprocessing import image\n","# import os\n","\n","# images = os.listdir(\"/tmp/images\")\n","\n","# print(images)\n","\n","# for i in images:\n","#  print()\n","#  # predicting images\n","#  path = '/tmp/images/' + i\n","#  img = image.load_img(path, target_size=(150, 150))\n","#  x = image.img_to_array(img)\n","#  x /= 255\n","#  x = np.expand_dims(x, axis=0)\n","\n","#  images = np.vstack([x])\n","#  classes = model.predict(images, batch_size=10)\n","#  print(classes[0])\n","#  if classes[0]>0.5:\n","#    print(i + \" is a human\")\n","#  else:\n","#    print(i + \" is a horse\")"]},{"cell_type":"markdown","metadata":{"id":"-8EHQyWGDvWz"},"source":["### Visualizing Intermediate Representations\n","\n","You can also look again at the intermediate representations. You will notice that the output at the last convolution layer is even more abstract because it contains fewer pixels than before."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"-5tES8rXFjux"},"outputs":[],"source":["%matplotlib inline\n","\n","import matplotlib.pyplot as plt\n","import numpy as np\n","import random\n","from tensorflow.keras.preprocessing.image import img_to_array, load_img\n","\n","# Define a new Model that will take an image as input, and will output\n","# intermediate representations for all layers in the previous model after\n","# the first.\n","successive_outputs = [layer.output for layer in model.layers[1:]]\n","visualization_model = tf.keras.models.Model(inputs = model.input, outputs = successive_outputs)\n","\n","# Prepare a random input image from the training set.\n","horse_img_files = [os.path.join(train_horse_dir, f) for f in train_horse_names]\n","human_img_files = [os.path.join(train_human_dir, f) for f in train_human_names]\n","img_path = random.choice(horse_img_files + human_img_files)\n","img = load_img(img_path, target_size=(150, 150))  # this is a PIL image\n","x = img_to_array(img)  # Numpy array with shape (150, 150, 3)\n","x = x.reshape((1,) + x.shape)  # Numpy array with shape (1, 150, 150, 3)\n","\n","# Scale by 1/255\n","x /= 255\n","\n","# Run the image through the network, thus obtaining all\n","# intermediate representations for this image.\n","successive_feature_maps = visualization_model.predict(x)\n","\n","# These are the names of the layers, so you can have them as part of the plot\n","layer_names = [layer.name for layer in model.layers[1:]]\n","\n","# Display the representations\n","for layer_name, feature_map in zip(layer_names, successive_feature_maps):\n","  if len(feature_map.shape) == 4:\n","\n","    # Just do this for the conv / maxpool layers, not the fully-connected layers\n","    n_features = feature_map.shape[-1]  # number of features in feature map\n","\n","    # The feature map has shape (1, size, size, n_features)\n","    size = feature_map.shape[1]\n","    \n","    # Tile the images in this matrix\n","    display_grid = np.zeros((size, size * n_features))\n","    for i in range(n_features):\n","      x = feature_map[0, :, :, i]\n","      x -= x.mean()\n","      x /= x.std()\n","      x *= 64\n","      x += 128\n","      x = np.clip(x, 0, 255).astype('uint8')\n","    \n","      # Tile each filter into this big horizontal grid\n","      display_grid[:, i * size : (i + 1) * size] = x\n","    \n","    # Display the grid\n","    scale = 20. / n_features\n","    plt.figure(figsize=(scale * n_features, scale))\n","    plt.title(layer_name)\n","    plt.grid(False)\n","    plt.imshow(display_grid, aspect='auto', cmap='viridis')"]},{"cell_type":"markdown","metadata":{"id":"j4IBgYCYooGD"},"source":["## Clean Up\n","\n","Please run the following cell to terminate the kernel and free memory resources:"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"651IgjLyo-Jx"},"outputs":[],"source":["import os, signal\n","os.kill(os.getpid(), signal.SIGKILL)"]},{"cell_type":"markdown","metadata":{"id":"tFnBvcIrXWW2"},"source":["## Wrap Up\n","\n","In this lab, you saw how compacting images affected your previous model. This is one technique to keep in mind especially when you are still in the exploratory phase of your own projects. You can see if a smaller model behaves just as well as a large model so you can have faster training. You also saw how easy it is to customize your images for this adjustment in size by simply changing a parameter in the `ImageDataGenerator` class."]}],"metadata":{"accelerator":"GPU","colab":{"collapsed_sections":[],"provenance":[{"file_id":"https://github.com/https-deeplearning-ai/tensorflow-1-public/blob/master/C1/W4/ungraded_labs/C1_W4_Lab_3_compacted_images.ipynb","timestamp":1662191056630},{"file_id":"https://github.com/https-deeplearning-ai/tensorflow-1-public/blob/adding_C1/C1/W4/ungraded_labs/C1_W4_Lab_3_compacted_images.ipynb","timestamp":1639112249467}],"toc_visible":true},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.7.4"},"gpuClass":"standard"},"nbformat":4,"nbformat_minor":0}